# 动态抽奖工具文档

## 需求分析

- 支持动态抽奖
- 形式
  - 自动机器人？ 
  - 离线客户端 [√] 
  - 在线网站
- 支持条件过滤**（必须转发）**
  - 是否需要@好友 （获取转发情况，做分析可得）
    - 不@好友
    - @一个好友
    - @两个好友
  - 是否需要关注主播 （**需要获取主播的账号密码才行**，这样的话只能做离线客户端）
    - 需要关注
    - 不需要关注
  - 是否需要评论动态（官方抽奖工具不带该功能）
    - 需要
    - 不需要
  - ~~是否需要转发动态的时候带指定话题（这个好像没啥用）~~
  - ~~是否需要点赞动态~~（暂时好像没法实现，尚未找到相关接口）
- 支持抽出1、2、3等奖最多各100位。（和官方工具一样）
- 支持第三方Check，所有抽奖结果需要上传到指定服务器做备份确认（防止重抽）



## 概要设计

程序实现：客户端 + WEB服务器

### 客户端部分

- Electron+Vue+Element.UI ，Vuido虽然打包体积小，但是暂时没找到打包方案。

  > **而且丑啊**

- 需要登录用户账号

  > 可以沿用之前的代码

- 需要能够通过网络获取用户数据

  > 可以沿用之前的代码

- 需要保存账号？

  > 保存吧……

- 需要支持账号验证？

  > 验证码啥的？ 怕up主不会用，输错多次密码导致没法继续登录……可以考虑，优先级不高，第一个版本不做吧

- 抽奖完毕后展示中奖用户

  - <u>自动发送中奖通知动态 ？</u> 

    > 转发原动态，恭喜@XXX @XXX @YYY等用户中奖，本次抽奖结果为 <u>link</u> ，公正公开 （由#BDR#提供技术支持）

  - <u>自动私信中奖用户？</u>

    > 恭喜你中奖啦，结果查看 <u>link</u> ，请私信我领奖哦 。

  - 其他功能？（没想好）

### 服务器部分

- 需要能够识别各个客户端上传的数据（保存就行）

  - 数据保存方案设计：

    一个dynamicID，对应一条数据，数据使用文本存储，数据的储存格式为约定好的JSON Config，形如：

    ```json
    {
        dynamicId:"number to Text (动态id超精度，使用字符串)",
        NeedAt:[0/1/2],
        NeedAttention:[0/1],
        NeedReplay:[0/1],
        FirstReward:[0-100],
        SecondReward:[0-100],
        ThirdReward:[0-100],
        isTrueRandom:[0/1],//是否使用了random.org的随机数
        Result:[
            FirstReward:[
                {
            		userID:"",//中奖的用户id
            		userName:"",//中奖的用户昵称
            		userFace:"",//中奖的用户头像
                },
            	...
            ],
            SecondReward:[
                {
                	//同一等奖 
                },
                ...
            ],
            ThirdReward:[
                {
                	//同一等奖
                },
                ...
            ]
        ]
    }
    ```

- 能够根据需要查询指定的dynamicID的抽奖结果，结果和展示由客户端完成

- 在上传抽奖结果的时候返回是否合法，不合法的结果不允许上传，并返回错误值（防止多次抽奖，仅以第一次的结果为准）。

> 安全性确认：
>
> 此处不做校验，仅保证数据在服务器内不被篡改，客户端不一定安全。
>
> 但是如果你的up主懂技术，那还用这个抽啥？自己写一个随便抽啊，想给谁给谁。

## 详细设计



### 数据库设计：

bdr : [res]

| 字段              | 类型     | 备注               |
| ----------------- | -------- | ------------------ |
| **[$] DynamicId** | char[20] | 动态Id (索引)      |
| userId            | char[20] | 抽奖的Up主Id       |
| config            | text     | 抽奖配置和结果信息 |

### 程序模块设计：

#### 客户端

- 用户登录 

  - 账号密码保存
  - 验证登录状态

- 抽奖条件配置

  - 动态Id（从获取的最近动态之中选择）
  - 其他配置（是否@，是否关注，是否评论，中奖人数 等）

- 抽奖过程

  - 获取转发列表 -> 剔除重复和不合法用户 ->获得【待抽奖列表】

  - 如果需要评论 -> 获取评论列表 并 和【待抽奖列表】做交集 （这个放前面，关注确认的工作量太大）

  - 如果需要关注 -> 获取粉丝列表 并 和【待抽奖列表】做交集（有几万关注的一定都开官方抽奖工具了）

  - 如果 -> 世界随机数网站 ( https://www.random.org ) 能够连接 ，按照random.org 从【待抽奖列表】生成【获奖列表】

    否则 -> 使用本地随机数，生成获奖列表。

#### 服务器

瞎几把乱写就行





## 相关参考

- 随机数 random.org，返回一个文本，使用split可切分出所有随机数

  ```
  https://www.random.org/integers/?num=10&min=1&max=11&col=10&base=10&format=plain&rnd=new
  ```

- B站获取粉丝API

  >  疑似只能获取前1000 的粉丝
  >
  > **Confirm，通过该api只能获取最后1k的粉丝**

  ```
  https://api.bilibili.com/x/relation/followers?vmid=179053897&re_version=0&pn=1&ps=50
  ```

- B站获取关注的人API

  > 用过该api获取每一个转发的用户的关注列表（至多250个，250个关注之内没找到就认为没有关注）

  ```
  https://api.bilibili.com/x/relation/followings?vmid=11512235&pn=1&ps=50
  ```

- 获取动态的转发数据API

  > 用//@ 作分隔符，如果在AtCtrl里面，这个位置刚好是个@，则认为这是其他人的转发，前面部分才是他自己的转发，以第一个分隔符为准，分割出他自己的转发，然后判断是否@了人

  ```
  https://api.vc.bilibili.com/dynamic_repost/v1/dynamic_repost/view_repost?uid=179053897&dynamic_id=131962131437439706&offset=45
  ```

- 获取动态评论数据

  > 获取动态评论数据

  ```
  https://api.bilibili.com/x/v2/reply?oid=4900540&type=11&pn=3&ps=10
  ```

------

**程序设计文档大概就是这样了**



